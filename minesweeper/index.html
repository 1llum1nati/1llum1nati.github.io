<!DOCTYPE HTML>
<html>

<head>
  <meta charset="utf-8">

  <style>
    td {
        width: 20px;
        height: 20px;
        background-color: rgb(85, 87, 90);
        border: 0.2px solid;
    }
    table {
        
    }
    .bomb {
        background-color: red;
    }
  </style>
  
</head>
<body>
    <div id="newGame" style="height: 100px; width: 200px; background-color: rgb(134, 155, 177); display: flex; align-items: center; justify-content: center">
        Новая игра
    </div>

    <div id="clear" style="margin-left: 250px; margin-top: -100px; height: 100px; width: 200px; background-color: rgb(134, 155, 177); display: flex; align-items: center; justify-content: center">
        Сброс
    </div>

    <table border="" id="field" cellspacing="0" style="margin-top: 20px; display: none; text-align: center;">
    </table>
  </body>
  <script>/*jshint esversion: 6 */
    const createField = document.querySelector('#newGame');
    const field = document.querySelector('#field');
    const countField = document.querySelector('#countOfFields');
    const clear = document.querySelector('#clear');
    const td = document.querySelectorAll('td');
    
    var currentVAmount = [];
    var currentHAmount = 0;
    var currentMines = 0;
    var mines = [];
    var minesCheck = [];
    var flag = 0;
    var win = 0;
    var v, h, difficulty;
    
    function newField() {
        h = v = prompt("Размер");
        if (v > 2 && h > 2) {
            difficulty = Math.round(v*h / 3);
            reset();
            field.style.display = 'table';
            for (let i = 0; i < v; i++) {
                const tr = document.createElement("tr"); 
                field.appendChild(tr);
                for (let j = 0; j < h; j++) {
                    const td = document.createElement("td"); 
                    td.setAttribute('x', i);
                    td.setAttribute('y', j);
                    td.setAttribute('id', (i*v +j));
                    field.appendChild(td);
                    }
                }
            
            while (flag != difficulty) {
                randX = Math.floor(Math.random() * v);
                randY = Math.floor(Math.random() * h);
                if (mines[randX][randY] != 9) {
                    mines[randX][randY] = 9;
                    flag++;
                }
            }

            for (let i = 0; i < v; i++) {
                for (let j = 0; j < h; j++) {
                    if (mines[i][j] != 9) {
                        mines[i][j] = setMines(i, j);
                        if (mines[i][j] == 0) {
                            mines[i][j] = "";
                        }
                    }
                }
            }
            createField.removeEventListener('click', newField);
        } else {
            alert("v < 2 && h < 2 !");
        }
    }

    function reset() {
        for (let i = 0; i < v; i++) {
            currentVAmount[i] = 0;
            mines[i] = [];
            for (let j = 0; j < h; j++) {
                mines[i][j] = 0;
            }
        }
        for (let i = 0; i < v; i++) {
            minesCheck[i] = [];
            for (let j = 0; j < h; j++) {
                minesCheck[i][j] = 0;
            }
        }
    }

    function main(event) {
        x = +event.target.getAttribute('x');
        y = +event.target.getAttribute('y');
        var color = document.getElementById(x*v+y);
        if (mine(x, y))  {
            color.style.backgroundColor = "red";
            openField();
            alert("bad");
        } else {
            clean(x, y);
            winCheck();
        }
    }

    field.addEventListener('mousedown', f = function(event) {
        main(event);
    });


    field.addEventListener('keydown', r = function(event) {
        if (event.keyCode == 49) {
            alert("PIZDa");
        }
    });
    

    field.addEventListener('contextmenu', e = function(event) {
        event.preventDefault();
    }, false);

    function mine(a, b) {
        if((a >= 0) && (a < v)) {
            if((b >= 0) && (b < h)) {
                if(mines[a][b] == 9) {
                    return 1;
                }
            }
        }
        return 0;

    }

    function setMines(e, r) {
        if ((e >= 0) && (e < v)) {
            if ((r >= 0) && (r < h)) {
                let k = 0;
                if (mine(e-1, r-1)) k++;
                if (mine(e-1,r)) k++;
                if (mine(e-1, r+1)) k++;
                if (mine(e, r-1)) k++;
                if (mine(e, r+1)) k++;
                if (mine(e+1, r-1)) k++;
                if (mine(e+1, r)) k++;
                if (mine(e+1, r+1)) k++;
                return k;
            }
        }
    }

    function empty(n, m) {
        if((n >= 0) && (n < v)) {
            if((m >= 0) && (m < h)) {
                if (mines[n][m] == "") 
                    return 1;
            }
        }
        return 0;
    }
 
    function openField() {
        for (let i = 0; i < v; i++) {
            for (let j = 0; j < h; j++) {
                if (mines[i][j] == 9) {
                    document.getElementById(i*v+j).style.backgroundColor = "red";
                } else {
                    document.getElementById(i*v+j).innerHTML = mines[i][j];
                    document.getElementById(i*v+j).style.backgroundColor = "white";
                }
            }
        }
        field.removeEventListener('mousedown', f);
    }
 
    function clean(f, g) {
        if ((f >= 0) && (f < v)) {
            if ((g >= 0) && (g < h)) {
                color = document.getElementById(f*v+g);
                color.style.backgroundColor = "white";
                color.innerHTML = mines[f][g];
                if (!minesCheck[f][g]) {
                    minesCheck[f][g] = 1;
                    win++; 
                    if (mines[f][g] == "") {
                        clean(f-1, g-1);
                        clean(f-1, g);
                        clean(f-1, g+1);
                        clean(f, g-1);
                        clean(f, g+1);
                        clean(f+1, g-1);
                        clean(f+1, g);
                        clean(f+1, g+1);
                    } else {
                        if (empty(f-1, g-1)) clean(f-1, g-1);
                        if (empty(f-1, g)) clean(f-1, g);
                        if (empty(f-1, g+1)) clean(f-1, g+1);
                        if (empty(f, g-1)) clean(f, g-1);
                        if (empty(f, g+1)) clean(f, g+1);
                        if (empty(f+1, g-1)) clean(f+1, g-1);
                        if (empty(f+1, g)) clean(f+1, g);
                        if (empty(f+1, g+1)) clean(f+1, g+1);
                    }
                }
            }
        }
    }

    function winCheck() {
        if (win == v*h - difficulty) {
            alert("gg");
        }
    }

    function clearField() {
        field.innerHTML = ``;
        field.style.display = 'none';
        currentMines = 0;
        win = 0;
        reset();
        flag = 0;
        createField.addEventListener('click', newField);
    }
    
    function getRandom() {
        return Math.round(Math.random());
    }
   createField.addEventListener('click', newField);
   clear.addEventListener('click', clearField);
  </script>
</html>